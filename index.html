<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Martial Arts Manager 2026</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js 3D Library (Updated to 0.160.0 for CapsuleGeometry support) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            height: 100%;
            margin: 0;
            padding: 0;
            color: #e5e7eb;
            background-color: #111827;
            position: relative;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(31, 41, 55, 0.5); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        #bg-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        #app {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .glass-panel {
            background-color: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: rgba(31, 41, 55, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        /* Match UI Specifics */
        .health-bar-fill { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hit-flash { animation: flash 0.1s ease-out; }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; background-color: rgba(255, 255, 255, 0.3); } 100% { opacity: 0; } }
        
        /* Floating Damage Text Animation */
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        .damage-text { position: absolute; font-weight: 900; animation: floatUp 1s ease-out forwards; text-shadow: 2px 2px 0 #000; pointer-events: none; }
    </style>
</head>
<body class="h-full">
    
    <canvas id="bg-canvas"></canvas>

    <div id="app" class="overflow-hidden">

        <!-- Character Creation (Same as before) -->
        <div id="creation-screen" class="flex-grow flex items-center justify-center p-4 w-full h-full overflow-y-auto">
            <div class="glass-panel w-full max-w-md rounded-xl p-8 my-auto">
                <h1 class="text-3xl font-bold text-center text-white mb-6">Create Your Legacy</h1>
                <div class="mb-5">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Fighter Name</label>
                    <input type="text" id="player-name" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 'Iron' Mike">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Career Path</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectPath('fighter')" class="career-path-btn flex flex-col items-center justify-center p-4 bg-gray-800 rounded-lg border border-gray-700 hover:bg-blue-600 hover:text-white transition-all group">
                            <span class="text-2xl mb-2">ðŸ¥Š</span><span class="font-medium">Fighter</span>
                        </button>
                        <button disabled class="flex flex-col items-center justify-center p-4 bg-gray-900 rounded-lg border border-gray-800 opacity-50 cursor-not-allowed"><span class="text-sm">Coach (Soon)</span></button>
                    </div>
                </div>
                <div id="discipline-select" class="mb-6 hidden">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Style</label>
                    <select id="fighter-discipline" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="muay-thai">Muay Thai</option>
                        <option value="bjj">BJJ</option>
                        <option value="boxing">Boxing</option>
                        <option value="mma">MMA</option>
                    </select>
                </div>
                <button id="start-game-btn" onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 px-4 rounded-lg shadow-lg disabled:opacity-50" disabled>Begin Career</button>
                 <div class="mt-4 text-center">
                    <button onclick="toggleApiKey()" class="text-xs text-gray-500 hover:text-gray-300 underline">API Settings (Optional)</button>
                    <div id="api-key-container" class="hidden mt-2">
                         <input type="password" id="user-api-key" class="w-full px-2 py-1 bg-gray-900 border border-gray-700 rounded text-xs text-white" placeholder="Gemini Key (Blank for Offline)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Game Hub -->
        <div id="hub-screen" class="hidden h-full flex flex-col overflow-hidden">
            <header class="glass-panel z-20 flex-shrink-0 border-b border-gray-700">
                <div class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
                    <h1 id="hub-player-name" class="text-xl md:text-2xl font-bold text-white tracking-tight">Player</h1>
                    <div class="flex items-center space-x-4 text-sm font-medium">
                        <span class="text-gray-300" id="hub-date">Week 1</span>
                        <span class="text-green-400" id="hub-money">$500</span>
                        <span class="text-blue-300" id="hub-record">0-0-0</span>
                    </div>
                </div>
            </header>
            <div class="flex-grow overflow-y-auto custom-scroll p-4">
                <main class="container mx-auto max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6 pb-6">
                    <!-- Stats -->
                    <section class="lg:col-span-4 glass-panel rounded-xl p-6 h-fit">
                        <h2 class="text-lg font-bold text-white mb-4">Fighter Stats</h2>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-1"><span class="text-gray-400">Health</span><span id="stat-health-text" class="text-white">100</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-2"><div id="stat-health-bar" class="bg-red-500 h-2 rounded-full" style="width: 100%"></div></div>
                        </div>
                        <div class="mb-6">
                            <div class="flex justify-between text-sm mb-1"><span class="text-gray-400">Stamina</span><span id="stat-stamina-text" class="text-white">100</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-2"><div id="stat-stamina-bar" class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-gray-800/50 p-2 rounded"> <div class="text-xs text-gray-400">Striking</div> <div id="stat-striking" class="text-lg font-bold text-blue-400">10</div> </div>
                            <div class="bg-gray-800/50 p-2 rounded"> <div class="text-xs text-gray-400">Grappling</div> <div id="stat-grappling" class="text-lg font-bold text-blue-400">10</div> </div>
                            <div class="bg-gray-800/50 p-2 rounded"> <div class="text-xs text-gray-400">Strength</div> <div id="stat-strength" class="text-lg font-bold text-blue-400">10</div> </div>
                            <div class="bg-gray-800/50 p-2 rounded"> <div class="text-xs text-gray-400">Fame</div> <div id="stat-fame" class="text-lg font-bold text-yellow-400">0</div> </div>
                        </div>
                    </section>
                    <!-- Actions -->
                    <section class="lg:col-span-4 glass-panel rounded-xl p-6 h-fit">
                        <h2 class="text-lg font-bold text-white mb-4">Weekly Plan</h2>
                        <div id="action-buttons" class="space-y-3">
                            <button onclick="performAction('train-striking')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg">Train Striking <span class="float-right text-xs text-gray-400">-$50</span></button>
                            <button onclick="performAction('train-grappling')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg">Train Grappling <span class="float-right text-xs text-gray-400">-$50</span></button>
                            <button onclick="performAction('train-strength')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg">Conditioning <span class="float-right text-xs text-gray-400">-$50</span></button>
                            <button onclick="performAction('rest')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg border-l-2 border-green-500">Rest & Recover</button>
                            <button onclick="performAction('promote')" class="w-full text-left px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg border-l-2 border-yellow-500">Promote Yourself âœ¨</button>
                            <button onclick="performAction('find-fight')" class="w-full text-left px-4 py-4 bg-blue-700 hover:bg-blue-600 rounded-lg font-bold shadow-lg mt-2">ðŸ¥Š Find Fight</button>
                        </div>
                        <div id="action-busy" class="hidden text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p class="text-white mb-4">Simulating...</p>
                            <button onclick="advanceWeek()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full">Next Week</button>
                        </div>
                    </section>
                    <!-- Logs -->
                    <section class="lg:col-span-4 glass-panel rounded-xl p-6 flex flex-col h-96 lg:h-auto">
                        <h2 class="text-lg font-bold text-white mb-4">Log</h2>
                        <div id="event-log" class="flex-grow overflow-y-auto custom-scroll space-y-2 pr-2 text-xs font-mono"></div>
                    </section>
                </main>
            </div>
        </div>

        <!-- MATCH ENGINE UI (Initially Hidden) -->
        <div id="match-screen" class="hidden absolute inset-0 z-30 flex flex-col justify-between pointer-events-none">
            <!-- Top Bar: Names & Round -->
            <div class="bg-black/60 backdrop-blur-md p-4 flex justify-between items-center text-white border-b border-white/10 pointer-events-auto">
                <div class="w-1/3">
                    <div class="text-2xl font-bold text-blue-400" id="match-p1-name">Player</div>
                    <div class="w-full bg-gray-700 h-3 rounded-full mt-1 overflow-hidden">
                        <div id="match-p1-health" class="health-bar-fill bg-blue-500 h-full w-full"></div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-black" id="match-timer">03:00</div>
                    <div class="text-sm text-gray-400 uppercase tracking-widest">Round <span id="match-round">1</span></div>
                </div>
                <div class="w-1/3 text-right">
                    <div class="text-2xl font-bold text-red-500" id="match-p2-name">Opponent</div>
                    <div class="w-full bg-gray-700 h-3 rounded-full mt-1 overflow-hidden">
                        <div id="match-p2-health" class="health-bar-fill bg-red-500 h-full w-full float-right"></div>
                    </div>
                </div>
            </div>

            <!-- Bottom Bar: Commentary -->
            <div class="p-6 pointer-events-auto">
                <div class="bg-black/80 backdrop-blur-md rounded-xl p-4 border border-white/10 max-w-3xl mx-auto">
                    <div id="match-commentary" class="text-lg text-center font-medium text-white h-8 transition-all">
                        The fighters touch gloves...
                    </div>
                </div>
            </div>
            
            <!-- Damage Text Container (Invisible layer) -->
            <div id="damage-overlay" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
        </div>

    </div>

    <!-- MODALS -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-40"></div>
    <div id="modal-container" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        
        <!-- Find Fight -->
        <div id="modal-find-fight" class="modal-content hidden w-full max-w-lg rounded-2xl p-8">
            <h2 class="text-2xl font-bold text-white mb-4">Fight Offer</h2>
            <div class="bg-gray-800 rounded-xl p-5 mb-6 border border-gray-700">
                <h3 id="opponent-name" class="text-xl font-bold text-red-400">--</h3>
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <span>Striking: <b id="opponent-striking" class="text-white">--</b></span>
                    <span>Grappling: <b id="opponent-grappling" class="text-white">--</b></span>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between">
                    <div class="text-green-400 font-bold">Win: <span id="fight-purse-win">--</span></div>
                    <div class="text-yellow-500 font-bold">Loss: <span id="fight-purse-lose">--</span></div>
                </div>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="scoutOpponent()" id="scout-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg">âœ¨ AI Scout</button>
                <div class="flex gap-3">
                    <button onclick="declineFight()" class="flex-1 py-3 bg-gray-700 text-white rounded-lg">Decline</button>
                    <button onclick="acceptFight()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-bold">ACCEPT FIGHT</button>
                </div>
            </div>
        </div>

        <!-- Post Match Report (Replaces old Fight Sim modal) -->
        <div id="modal-post-match" class="modal-content hidden w-full max-w-lg rounded-2xl p-8 text-center">
            <h2 id="post-match-title" class="text-4xl font-black mb-2">VICTORY</h2>
            <p id="post-match-desc" class="text-gray-300 mb-6 text-lg">You knocked him out!</p>
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <div class="flex justify-between border-b border-gray-700 pb-2 mb-2">
                    <span>Purse</span> <span id="post-match-purse" class="text-green-400 font-bold">+$500</span>
                </div>
                <div class="flex justify-between">
                    <span>Fame</span> <span id="post-match-fame" class="text-yellow-400 font-bold">+10</span>
                </div>
            </div>
            <button onclick="endMatch()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">Return to Gym</button>
        </div>

        <!-- Generic / Events -->
        <div id="modal-event" class="modal-content hidden w-full max-w-md rounded-2xl p-6 text-center">
            <h2 id="event-title" class="text-2xl font-bold text-white mb-2">Event</h2>
            <p id="event-description" class="text-gray-300 mb-6">--</p>
            <button onclick="closeModal(finishWeek)" class="px-8 py-2 bg-blue-600 rounded-lg text-white font-bold">OK</button>
        </div>

        <!-- Hype/Scout Modals -->
        <div id="modal-ai-content" class="modal-content hidden w-full max-w-md rounded-2xl p-6">
            <h2 class="text-xl font-bold text-blue-400 mb-4" id="ai-title">âœ¨ AI Content</h2>
            <div class="bg-gray-900/50 rounded-lg p-4 min-h-[80px] mb-4">
                 <p id="ai-text" class="text-gray-300 text-sm leading-relaxed italic">Loading...</p>
            </div>
            <button onclick="closeModal()" class="w-full py-2 bg-gray-700 text-white rounded-lg">Close</button>
        </div>
    </div>

    <script>
        // --- 3D SCENE & FIGHTERS ---
        let scene, camera, renderer, bgCanvas;
        let playerMesh, opponentMesh;
        let cameraTargetPos = new THREE.Vector3(0, 4, 15); 
        let isFighting = false;

        function initThree() {
            bgCanvas = document.getElementById('bg-canvas');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827); 
            scene.fog = new THREE.Fog(0x111827, 10, 50);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 4, 15);
            camera.lookAt(0, 1, 0);

            renderer = new THREE.WebGLRenderer({ canvas: bgCanvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // Lights
            const amb = new THREE.AmbientLight(0x404040, 3); scene.add(amb);
            const spot = new THREE.SpotLight(0xffffff, 1, 50, 0.5, 0.5, 1);
            spot.position.set(0, 20, 0); spot.lookAt(0,0,0); scene.add(spot);

            // Ring Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(16, 16), new THREE.MeshStandardMaterial({ color: 0x1f2937, roughness: 0.4 }));
            floor.rotation.x = -Math.PI / 2; floor.position.y = -2; scene.add(floor);
            
            // Ropes
            const postGeo = new THREE.CylinderGeometry(0.1, 0.1, 4);
            const postMat = new THREE.MeshStandardMaterial({ color: 0x9ca3af });
            [ [4, -2, 4], [-4, -2, 4], [4, -2, -4], [-4, -2, -4] ].forEach(p => {
                const m = new THREE.Mesh(postGeo, postMat); m.position.set(...p); m.position.y += 2; scene.add(m);
            });

            // FIGHTERS
            const fighterGeo = new THREE.CapsuleGeometry(0.5, 1.8, 4, 8);
            
            // Player (Blue)
            playerMesh = new THREE.Mesh(fighterGeo, new THREE.MeshStandardMaterial({ color: 0x3b82f6 }));
            playerMesh.position.set(-2, -0.1, 0); // Left side
            scene.add(playerMesh);

            // Opponent (Red)
            opponentMesh = new THREE.Mesh(fighterGeo, new THREE.MeshStandardMaterial({ color: 0xef4444 }));
            opponentMesh.position.set(2, -0.1, 0); // Right side
            scene.add(opponentMesh);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            // Smooth Camera
            camera.position.lerp(cameraTargetPos, 0.05);
            camera.lookAt(0, 0, 0);
            
            // Idle Animation (Bobbing)
            if (isFighting) {
                const time = Date.now() * 0.005;
                playerMesh.position.y = -0.1 + Math.sin(time) * 0.05;
                opponentMesh.position.y = -0.1 + Math.sin(time + 2) * 0.05;
            }

            renderer.render(scene, camera);
        }

        // --- ANIMATION HELPERS ---
        function animateAttack(attacker, target) {
            const originalPos = attacker.position.x;
            const direction = attacker === playerMesh ? 1 : -1; // Player moves right (+), Opp left (-)
            
            // Lunge
            let start = Date.now();
            let anim = setInterval(() => {
                let p = (Date.now() - start) / 150; // 150ms lunge
                if (p > 1) {
                    clearInterval(anim);
                    attacker.position.x = originalPos; // Reset
                } else {
                    if (p < 0.5) attacker.position.x = originalPos + (direction * 1.5 * (p * 2)); // Forward
                    else attacker.position.x = originalPos + (direction * 1.5 * ((1-p) * 2)); // Back
                }
            }, 16);
        }

        function animateHit(mesh) {
            const originalColor = mesh.material.color.getHex();
            mesh.material.color.setHex(0xffffff); // Flash white
            setTimeout(() => {
                mesh.material.color.setHex(originalColor);
            }, 100);
            
            // Simple shake
            mesh.position.z += 0.2;
            setTimeout(() => mesh.position.z -= 0.2, 50);
        }

        function showDamageText(amount, targetMesh) {
            const div = document.createElement('div');
            div.className = 'damage-text text-4xl text-red-500';
            div.innerText = amount;
            
            // Convert 3D position to 2D screen pos
            const vec = targetMesh.position.clone();
            vec.y += 2; // Above head
            vec.project(camera);
            
            const x = (vec.x * .5 + .5) * window.innerWidth;
            const y = (-(vec.y * .5) + .5) * window.innerHeight;
            
            div.style.left = x + 'px';
            div.style.top = y + 'px';
            
            document.getElementById('damage-overlay').appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }


        // --- GAME STATE & LOGIC ---
        let gameState = {
            playerName: "",
            discipline: "mma",
            week: 1,
            year: 2026,
            stats: { money: 500, health: 100, maxHealth: 100, stamina: 100, striking: 10, grappling: 10, strength: 10, fame: 0 },
            record: { w: 0, l: 0, d: 0 },
            isBusy: false,
            matchState: { p1hp: 100, p2hp: 100, time: 180 }
        };

        // --- SETUP ---
        function selectPath() {
            document.getElementById('discipline-select').classList.remove('hidden');
            document.getElementById('start-game-btn').disabled = false;
        }
        function toggleApiKey() { document.getElementById('api-key-container').classList.toggle('hidden'); }
        
        function startGame() {
            const name = document.getElementById('player-name').value || "Fighter";
            gameState.playerName = name;
            gameState.discipline = document.getElementById('fighter-discipline').value;
            // Set bonuses
            if (gameState.discipline === 'muay-thai') gameState.stats.striking += 5;
            if (gameState.discipline === 'bjj') gameState.stats.grappling += 5;
            
            document.getElementById('creation-screen').classList.add('hidden');
            document.getElementById('hub-screen').classList.remove('hidden');
            updateUI();
            
            // Camera to Hub View
            cameraTargetPos.set(0, 4, 15);
        }

        // --- HUB ACTIONS ---
        function performAction(action) {
            if (gameState.isBusy) return;
            gameState.isBusy = true;

            if (action === 'find-fight') {
                // Generate Opponent
                let level = gameState.record.w + 1;
                gameState.opponent = {
                    name: "Rival #" + Math.floor(Math.random()*100),
                    str: 8 + (level*2), grp: 8 + (level*2),
                    purse: 200 + (level*50)
                };
                document.getElementById('opponent-name').innerText = gameState.opponent.name;
                document.getElementById('opponent-striking').innerText = gameState.opponent.str;
                document.getElementById('opponent-grappling').innerText = gameState.opponent.grp;
                document.getElementById('fight-purse-win').innerText = "$"+gameState.opponent.purse;
                document.getElementById('fight-purse-lose').innerText = "$"+(gameState.opponent.purse/4);
                
                showModal('modal-find-fight');
                return; 
            }
            
            if (action === 'promote') {
                callAI("Generate a hype tweet for fighter " + gameState.playerName).then(txt => {
                    document.getElementById('ai-title').innerText = "ðŸ“£ Viral Tweet";
                    document.getElementById('ai-text').innerText = txt;
                    showModal('modal-ai-content');
                });
                gameState.stats.fame += 2;
                finishAction();
                return;
            }

            // Training Logic
            document.getElementById('action-busy').classList.remove('hidden');
            document.getElementById('action-buttons').classList.add('hidden');
            
            setTimeout(() => {
                if (action.includes('train')) {
                    gameState.stats.stamina -= 20; gameState.stats.money -= 50;
                    if (action.includes('striking')) gameState.stats.striking++;
                    if (action.includes('grappling')) gameState.stats.grappling++;
                    if (action.includes('strength')) gameState.stats.strength++;
                    addLog("Training complete.");
                } else {
                    gameState.stats.stamina = 100; gameState.stats.health = 100;
                    addLog("Rested.");
                }
                finishAction();
            }, 1000);
        }

        function finishAction() {
            gameState.isBusy = false;
            gameState.week++;
            gameState.stats.money -= 20; // Living costs
            updateUI();
            document.getElementById('action-busy').classList.add('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');
        }

        function advanceWeek() {} // handled inside finishAction mostly

        // --- AI ---
        async function scoutOpponent() {
            const btn = document.getElementById('scout-btn');
            btn.innerText = "Scouting...";
            const txt = await callAI("Scout report for opponent with stats " + gameState.opponent.str);
            document.getElementById('ai-title').innerText = "ðŸ“‹ Scout Report";
            document.getElementById('ai-text').innerText = txt;
            showModal('modal-ai-content');
            btn.innerText = "âœ¨ AI Scout";
        }

        async function callAI(prompt) {
            const key = document.getElementById('user-api-key').value;
            if (!key) return "Offline Coach: He looks tough. Keep your hands up! (Add API Key for more)";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                if (!res.ok) throw new Error();
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "Coach is busy (API Error)."; }
        }


        // --- MATCH ENGINE ---
        let matchInterval;
        
        function acceptFight() {
            closeModal();
            startMatch();
        }
        function declineFight() { closeModal(); gameState.isBusy = false; }

        function startMatch() {
            // UI Switch
            document.getElementById('hub-screen').classList.add('hidden');
            document.getElementById('match-screen').classList.remove('hidden');
            
            // Camera Move to Ringside
            cameraTargetPos.set(0, 2, 8); // Low angle, close up
            
            // Setup Match State
            gameState.matchState = { p1hp: 100, p2hp: 100, time: 180 };
            isFighting = true;
            playerMesh.rotation.z = 0; opponentMesh.rotation.z = 0; // Reset rotations
            playerMesh.position.set(-2, -0.1, 0); opponentMesh.position.set(2, -0.1, 0);

            document.getElementById('match-p1-name').innerText = gameState.playerName;
            document.getElementById('match-p2-name').innerText = gameState.opponent.name;
            updateMatchUI();
            
            matchInterval = setInterval(gameLoop, 1000); // Game tick every 1s
            setCommentary("FIGHT!");
        }

        function gameLoop() {
            const ms = gameState.matchState;
            ms.time -= 5; // 5 seconds per tick
            
            // 1. Determine Attacker (Random + Speed)
            const p1Turn = Math.random() > 0.5;
            const attacker = p1Turn ? playerMesh : opponentMesh;
            const defender = p1Turn ? opponentMesh : playerMesh;
            const attackerStats = p1Turn ? gameState.stats : gameState.opponent;
            const defenderStats = p1Turn ? gameState.opponent : gameState.stats;

            // 2. Calculate Hit Chance
            const hitChance = 0.6 + ((attackerStats.striking || attackerStats.str) * 0.02);
            const isHit = Math.random() < hitChance;

            // 3. Animation
            animateAttack(attacker, defender);
            
            // 4. Resolve
            if (isHit) {
                const damage = 5 + Math.floor(Math.random() * 10);
                
                setTimeout(() => {
                    animateHit(defender);
                    showDamageText(damage, defender);
                    
                    if (p1Turn) ms.p2hp -= damage;
                    else ms.p1hp -= damage;
                    
                    updateMatchUI();
                    setCommentary(p1Turn ? `${gameState.playerName} lands a clean hit!` : `${gameState.opponent.name} strikes back!`);
                    
                    checkKO();
                }, 300); // Delay impact to match lunge animation
            } else {
                 setCommentary("Missed swing!");
            }

            // End of Time
            if (ms.time <= 0) endRound();
            updateMatchUI();
        }

        function checkKO() {
            const ms = gameState.matchState;
            if (ms.p1hp <= 0 || ms.p2hp <= 0) {
                clearInterval(matchInterval);
                const winner = ms.p1hp > 0;
                setCommentary(winner ? "KNOCKOUT! YOU WIN!" : "YOU GOT KNOCKED OUT!");
                
                // Fall over animation
                const loserMesh = winner ? opponentMesh : playerMesh;
                loserMesh.rotation.z = winner ? Math.PI / 2 : -Math.PI / 2;
                loserMesh.position.y = -1.5; // Drop to floor
                
                setTimeout(() => showPostMatch(winner), 2000);
            }
        }

        function endRound() {
            clearInterval(matchInterval);
            // Decision (simplified: health check)
            const winner = gameState.matchState.p1hp > gameState.matchState.p2hp;
            setCommentary("Time! Going to the scorecards...");
            setTimeout(() => showPostMatch(winner), 2000);
        }

        function showPostMatch(won) {
            isFighting = false;
            const title = document.getElementById('post-match-title');
            const desc = document.getElementById('post-match-desc');
            
            if (won) {
                title.innerText = "VICTORY"; title.className = "text-4xl font-black mb-2 text-green-500";
                desc.innerText = "Great performance!";
                gameState.record.w++;
                gameState.stats.money += gameState.opponent.purse;
                gameState.stats.fame += 5;
            } else {
                title.innerText = "DEFEAT"; title.className = "text-4xl font-black mb-2 text-red-500";
                desc.innerText = "Back to the gym.";
                gameState.record.l++;
                gameState.stats.money += (gameState.opponent.purse / 4);
            }
            gameState.stats.health = Math.max(10, gameState.matchState.p1hp); // Carry over damage
            
            // Camera Back
            cameraTargetPos.set(0, 4, 15);
            showModal('modal-post-match');
        }

        function endMatch() {
            closeModal();
            document.getElementById('match-screen').classList.add('hidden');
            document.getElementById('hub-screen').classList.remove('hidden');
            finishAction();
        }

        function updateMatchUI() {
            const ms = gameState.matchState;
            const mins = Math.floor(ms.time / 60);
            const secs = ms.time % 60;
            document.getElementById('match-timer').innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
            
            document.getElementById('match-p1-health').style.width = Math.max(0, ms.p1hp) + "%";
            document.getElementById('match-p2-health').style.width = Math.max(0, ms.p2hp) + "%";
        }

        function setCommentary(text) {
            const el = document.getElementById('match-commentary');
            el.style.opacity = 0;
            setTimeout(() => { el.innerText = text; el.style.opacity = 1; }, 100);
        }

        // --- UTILS ---
        function updateUI() {
            document.getElementById('hub-player-name').innerText = gameState.playerName;
            // FIX: Removed 'hub-week' because it does not exist in HTML.
            // document.getElementById('hub-week').innerText = "Week " + gameState.week;
            document.getElementById('hub-date').innerText = `Week ${gameState.week}`; // Use existing 'hub-date'
            document.getElementById('hub-money').innerText = "$" + gameState.stats.money;
            document.getElementById('hub-record').innerText = `${gameState.record.w}-${gameState.record.l}-${gameState.record.d}`;
            
            ['health','stamina','striking','grappling','strength','fame'].forEach(k => {
               const el = document.getElementById('stat-'+k);
               if (el) el.innerText = gameState.stats[k];
               const bar = document.getElementById('stat-'+k+'-bar');
               if (bar) bar.style.width = gameState.stats[k]+"%";
            });
        }

        function showModal(id) {
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('modal-container').classList.remove('hidden');
            document.querySelectorAll('.modal-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal(cb) {
            document.getElementById('modal-backdrop').classList.add('hidden');
            document.getElementById('modal-container').classList.add('hidden');
            if(cb) cb();
        }
        function addLog(msg) {
            const d = document.createElement('div');
            d.className = "text-gray-400 border-b border-white/10 pb-1";
            d.innerText = `[W${gameState.week}] ${msg}`;
            document.getElementById('event-log').prepend(d);
        }

        window.onload = initThree;
    </script>
</body>
</html>
